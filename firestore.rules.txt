rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /charging_records/{recordId} {
      
      // Allow creation if user is authenticated
      allow create: if request.auth != null;
      
      // Allow read/update/delete if:
      // 1. The record belongs to the user (uid matches)
      // OR
      // 2. The requester is the admin (km520daisy@gmail.com)
      allow read, update, delete: if request.auth != null && (
        resource.data.uid == request.auth.uid || 
        request.auth.token.email == 'km520daisy@gmail.com'
      );
      
      // Special case for list queries (Collection Group queries):
      // Firestore security rules apply to the *result* of the query.
      // - Normal user query: where("uid", "==", currentUid) -> Passes 'resource.data.uid == request.auth.uid'
      // - Admin query: collection() -> Passes 'request.auth.token.email == ...'
    }
  }
}